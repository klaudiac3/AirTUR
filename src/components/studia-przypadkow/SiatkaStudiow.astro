---
// src/components/studia-przypadkow/SiatkaStudiow.astro
import { getCollection } from 'astro:content';

// 1. Pobieramy dane z plików .md
const allCases = await getCollection('cases');

// 2. Sortujemy według caseId (1, 2, 3...)
const sortedCases = allCases.sort((a, b) => {
    return (Number(a.data.caseId) || 0) - (Number(b.data.caseId) || 0);
});

// 3. Nieskończona pętla: Potrójny bufor [kopia, oryginał, kopia]
const loopedCases = [...sortedCases, ...sortedCases, ...sortedCases];
---

<section class="bg-white py-12 md:py-20 overflow-hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative group">
    
    <!-- Kontener Slidera -->
    <div class="overflow-hidden -mx-4 px-4 md:mx-0 md:px-0">
      <!-- items-stretch: wymusza równą wysokość wszystkich dzieci -->
      <div 
        id="cases-track"
        class="flex gap-8 items-stretch" 
        style="will-change: transform;"
      >
        {loopedCases.map((item) => (
          <div class="shrink-0 w-[85vw] md:w-[45%] lg:w-[32%] flex flex-col h-auto card-item transition-opacity duration-300">
            
            <!-- KARTA -->
            <!-- Link generowany dynamicznie ze sluga pliku -->
            <a href={`/studia-przypadkow/${item.slug}`} class="group/card flex flex-col h-full bg-white border border-gray-200 rounded-2xl overflow-hidden hover:border-airtur-blue hover:shadow-2xl transition-all duration-300 relative">
              
              <!-- ZDJĘCIE (Poziome) -->
              <div class="relative h-56 overflow-hidden flex-shrink-0 bg-gray-100">
                <img 
                  src={item.data.image} 
                  alt={item.data.title} 
                  class="w-full h-full object-cover transition-transform duration-700 group-hover/card:scale-110"
                  onerror="this.src='https://placehold.co/600x400/F3F4F6/3A4149?text=Realizacja';"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-80"></div>
                
                <div class="absolute bottom-4 left-4">
                    <span class="bg-airtur-blue text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide shadow-sm">
                        {item.data.location}
                    </span>
                </div>
              </div>

              <!-- TREŚĆ KARTY -->
              <div class="p-6 flex flex-col flex-grow">
                
                <!-- Nagłówek -->
                <h3 class="text-xl font-bold text-airtur-dark mb-4 group-hover/card:text-airtur-blue transition-colors leading-snug">
                  {item.data.tile_data.title_tile || item.data.title}
                </h3>

                <!-- Sekcje: Problem, Rozwiązanie, Efekt -->
                <div class="space-y-4 mb-6 flex-grow">
                    
                    <!-- Problem -->
                    <div class="pl-3 border-l-2 border-red-400">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Problem</p>
                        <p class="text-sm text-gray-700 leading-snug">{item.data.tile_data.problem_short}</p>
                    </div>

                    <!-- Rozwiązanie -->
                    <div class="pl-3 border-l-2 border-airtur-blue">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Rozwiązanie</p>
                        <p class="text-sm text-gray-700 leading-snug">{item.data.tile_data.solution_short}</p>
                    </div>

                    <!-- Efekt -->
                    <div class="pl-3 border-l-2 border-green-500 bg-green-50/50 py-1 rounded-r-lg">
                        <p class="text-[10px] text-green-600 uppercase font-bold tracking-wider">Efekt</p>
                        <p class="text-sm text-airtur-dark font-bold">{item.data.tile_data.result_short}</p>
                    </div>

                    <!-- Krótki opis -->
                    <p class="text-sm text-gray-500 leading-relaxed pt-2 border-t border-gray-100 italic line-clamp-3">
                        "{item.data.excerpt}"
                    </p>
                </div>

                <!-- Przycisk -->
                <div class="mt-auto pt-4">
                    <div class="w-full py-3 bg-white border border-airtur-blue text-airtur-blue rounded-lg font-bold text-sm text-center group-hover/card:bg-airtur-blue group-hover/card:text-white transition-all duration-300 flex items-center justify-center gap-2">
                        ZOBACZ PEŁNĄ ANALIZĘ
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 0 1 .359.852L12.982 9.75h7.268a.75.75 0 0 1 .548 1.262l-10.5 11.25a.75.75 0 0 1-1.272-.71l1.992-7.302H3.75a.75.75 0 0 1-.548-1.262l10.5-11.25a.75.75 0 0 1 .913-.143Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>

              </div>

            </a>
          </div>
        ))}
      </div>
    </div>

    <!-- STRZAŁKI NAWIGACYJNE (Widoczne na Mobile i Desktop) -->
    <!-- ZMIANY: 
         1. Usunięto 'hidden'.
         2. Dodano 'left-2' (mobile) i 'md:-left-6' (desktop).
         3. Zmniejszono rozmiar na mobile 'w-10 h-10', a na desktopie 'md:w-14 md:h-14'.
    -->
    <button id="slide-left" class="flex absolute top-1/2 left-2 md:-left-6 -translate-y-1/2 w-10 h-10 md:w-14 md:h-14 bg-white/90 md:bg-white border border-gray-200 rounded-full items-center justify-center shadow-xl text-airtur-dark hover:text-airtur-blue hover:border-airtur-blue transition z-20 cursor-pointer backdrop-blur-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 md:w-6 md:h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12 15.75 4.5" />
      </svg>
    </button>
    
    <button id="slide-right" class="flex absolute top-1/2 right-2 md:-right-6 -translate-y-1/2 w-10 h-10 md:w-14 md:h-14 bg-white/90 md:bg-white border border-gray-200 rounded-full items-center justify-center shadow-xl text-airtur-dark hover:text-airtur-blue hover:border-airtur-blue transition z-20 cursor-pointer backdrop-blur-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 md:w-6 md:h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5 15.75 12 8.25 19.5" />
      </svg>
    </button>

  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const track = document.getElementById("cases-track");
  const leftBtn = document.getElementById('slide-left');
  const rightBtn = document.getElementById('slide-right');
  
  if (!track) return;

  const items = Array.from(track.children);
  const totalItems = items.length;
  const count = totalItems / 3; 
  
  let currentIndex = count; 
  
  const getCardWidth = () => {
    const item = items[0] as HTMLElement;
    const style = window.getComputedStyle(track);
    const gap = parseFloat(style.gap) || 0;
    return item.offsetWidth + gap;
  };

  const updatePosition = (smooth = true) => {
    const width = getCardWidth();
    track.style.transition = smooth ? "transform 0.5s ease-out" : "none";
    track.style.transform = `translateX(-${currentIndex * width}px)`;
  };

  setTimeout(() => updatePosition(false), 50);

  track.addEventListener('transitionend', () => {
    const width = getCardWidth();
    if (currentIndex >= count * 2) {
      track.style.transition = 'none';
      currentIndex = count; 
      track.style.transform = `translateX(-${currentIndex * width}px)`;
    }
    if (currentIndex < count) {
      track.style.transition = 'none';
      currentIndex = count * 2 - 1; 
      track.style.transform = `translateX(-${currentIndex * width}px)`;
    }
  });

  const handleNext = () => {
    currentIndex++;
    updatePosition(true);
  };

  const handlePrev = () => {
    currentIndex--;
    updatePosition(true);
  };

  rightBtn?.addEventListener('click', handleNext);
  leftBtn?.addEventListener('click', handlePrev);

  window.addEventListener('resize', () => updatePosition(false));
});
</script>