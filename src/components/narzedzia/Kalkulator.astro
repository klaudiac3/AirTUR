---
// src/components/narzedzia/Kalkulator.astro

// Importujemy poszczeg贸lne kroki
import Step1 from './kalkulator/Step1.astro';
import Step2 from './kalkulator/Step2.astro';
import Step3 from './kalkulator/Step3.astro';
import Step4 from './kalkulator/Step4.astro';
---

<section id="kalkulator-app" class="relative bg-white min-h-[600px] transition-all duration-300 pb-24 scroll-mt-24">
  
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <div class="relative pt-8">
        
        <Step1 />
        <Step2 />
        <Step3 />
        <Step4 />

        <div id="step-loading" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-30 flex flex-col items-center justify-center text-center min-h-[400px]">
            <div class="relative w-24 h-24 mb-6">
               <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
               <div class="absolute inset-0 border-4 border-airtur-blue rounded-full border-t-transparent animate-spin"></div>
               <div class="absolute inset-0 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 text-airtur-blue">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 1.043 3.296 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                  </svg>
               </div>
            </div>
            <h3 class="text-xl font-bold text-airtur-dark mb-1 animate-pulse">Przetwarzanie danych...</h3>
            <p class="text-sm text-gray-500">Analiza fizyki budynku i koszt贸w energii</p>
        </div>

    </div>

  </div>
</section>

<script>
  // IMPORT Z PLIKU KONFIGURACYJNEGO
  import { models, MARKET_DATA, selectThreeModels, TIERS, transitionContent } from './kalkulator/models.js';

  document.addEventListener('DOMContentLoaded', () => {

    // --- STAN APLIKACJI ---
    let state = {
      buildingType: '',
      buildingFactor: 1.0,
      goal: '',
      area: 25,          
      sunFactor: 0.10,   
      peopleLoad: 0,     
      calculatedPower: 0,
      billAmount: 800,   
      
      selectedFuel: null, 
      comfortLevel: 'standard', 
      
      // Nowe pola do obsugi 3 modeli
      selectedModels: { eco: null, smart: null, premium: null },
      activeModelKey: 'smart', // Domylnie wybieramy rodkowy (To nasz TIER)
      
      recommendedModel: '', 
      recommendedDesc: '', 
      
      savingsYear: 0,
      savings5Years: 0,
      savings10Years: 0
    };

    // --- ELEMENTY DOM ---
    const steps = [
      document.getElementById('step-1'),
      document.getElementById('step-2'),
      document.getElementById('step-3'),
      document.getElementById('step-4')
    ];
    const stepLoading = document.getElementById('step-loading');
    const progressLine = document.getElementById('progress-line');
    const appContainer = document.getElementById('kalkulator-app'); 

    // ============================================================
    // 1. SYNCHRONIZACJA Z FORMULARZEM
    // ============================================================
    function syncWithConversionForm() {
        const goalBtn = document.querySelector(`.goal-btn[data-goal="${state.goal}"]`);
        const goalLabel = goalBtn ? goalBtn.innerText.split('\n')[0] : state.goal; 
        
        const fuelData = state.selectedFuel ? MARKET_DATA.fuels[state.selectedFuel] : null;
        const fuelName = fuelData ? fuelData.name : 'Nieznane';

        let sunLabel = "rednie";
        if(state.sunFactor === 0.08) sunLabel = "Niskie";
        if(state.sunFactor === 0.13) sunLabel = "Wysokie";

        let comfortLabel = "Standardowy (21掳C)";
        if(state.comfortLevel === 'low') comfortLabel = "Oszczdny (<20掳C)";
        if(state.comfortLevel === 'high') comfortLabel = "Wysoki (>22掳C)";

        const setVal = (selector, val) => {
            document.querySelectorAll(selector).forEach(el => el.value = val);
        };

        setVal('.calc-field-area', state.area + " m虏"); 
        setVal('.calc-field-power', state.calculatedPower + " kW");
        setVal('.calc-field-goal', goalLabel);
        
        setVal('.calc-field-savings', state.savingsYear + " z");
        setVal('.calc-field-savings5', state.savings5Years + " z");   
        setVal('.calc-field-savings10', state.savings10Years + " z"); 

        //  KLUCZOWA ZMIANA: Wysyamy nie tylko nazw, ale i wybrany TIER (eco/smart/premium)
        setVal('.calc-field-model', state.recommendedModel);
        setVal('.calc-field-tier', state.activeModelKey);
        
        setVal('.calc-field-explanation', state.recommendedDesc);

        setVal('.calc-field-bill', state.billAmount + " z");
        setVal('.calc-field-fuel', fuelName);
        setVal('.calc-field-comfort', comfortLabel);
        setVal('.calc-field-sun', sunLabel);
        setVal('.calc-field-people', state.peopleLoad > 0 ? "3+" : "1-2");
        setVal('.calc-field-building', state.buildingType ? state.buildingType.toUpperCase() : '');
    }

    // ============================================================
    // 2. NAWIGACJA I UI - PROFESJONALNY SCROLL
    // ============================================================
    
    function scrollToTop() {
        if (appContainer) {
            setTimeout(() => {
                appContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50); 
        }
    }

    function goToStep(stepIndex) {
      if(!steps[stepIndex]) return;
      steps.forEach(s => s && s.classList.add('hidden'));
      steps[stepIndex].classList.remove('hidden');
      scrollToTop();
      updateProgress(stepIndex + 1);
    }

    function updateProgress(stepNumber) {
      if(progressLine) {
          if(stepNumber === 1) progressLine.style.width = '0%';
          if(stepNumber === 2) progressLine.style.width = '50%';
          if(stepNumber >= 3) progressLine.style.width = '100%';
      }
      const circles = document.querySelectorAll('.w-10.h-10.rounded-full'); 
      circles.forEach((circle, idx) => {
          if(idx + 1 <= stepNumber || (stepNumber === 4 && idx === 2)) {
              circle.classList.remove('bg-white', 'text-gray-400', 'border-2', 'border-gray-200');
              circle.classList.add('bg-airtur-blue', 'text-white');
          } else {
              circle.classList.remove('bg-airtur-blue', 'text-white');
              circle.classList.add('bg-white', 'text-gray-400', 'border-2', 'border-gray-200');
          }
      });
    }

    document.querySelectorAll('.back-btn').forEach(btn => {
      btn.addEventListener('click', () => {
          const prevStep = parseInt(btn.dataset.prev);
          goToStep(prevStep - 1);
      });
    });

    document.querySelectorAll('.reset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
          if(confirm("Czy na pewno chcesz zresetowa kalkulator i zacz od pocztku?")) {
              location.reload(); 
          }
      });
    });

    const scrollToElement = (element) => {
        if(element) {
            setTimeout(() => {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    };

    // Obsuga Input贸w Step 2
    document.querySelectorAll('input[name="sun"]').forEach(r => {
      r.addEventListener('change', (e) => { 
          state.sunFactor = parseFloat(e.target.value);
          updateSunDescription(state.sunFactor);
          const peopleContainer = document.querySelector('input[name="people"]')?.closest('.mb-10');
          scrollToElement(peopleContainer);
      });
    });

    document.querySelectorAll('input[name="people"]').forEach(r => {
      r.addEventListener('change', (e) => { 
          state.peopleLoad = parseFloat(e.target.value); 
          const calcBtn = document.getElementById('calculate-btn');
          scrollToElement(calcBtn);
      });
    });

    // Obsuga Input贸w Step 3
    const heatBtns = document.querySelectorAll('.heat-btn');
    heatBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          heatBtns.forEach(b => {
              b.classList.remove('border-airtur-blue', 'bg-blue-50');
              b.classList.add('border-gray-200');
          });
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-airtur-blue', 'bg-blue-50');
          state.selectedFuel = btn.dataset.fuel;
          
          const comfortContainer = document.querySelector('input[name="comfort"]')?.closest('.mb-12');
          scrollToElement(comfortContainer);
      });
    });

    const comfortRadios = document.querySelectorAll('input[name="comfort"]');
    comfortRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            state.comfortLevel = e.target.value;
            const roiBtn = document.getElementById('roi-btn');
            scrollToElement(roiBtn);
        });
    });


    // ============================================================
    // 3. LOGIKA KROKU 1 (PROFIL BUDYNKU)
    // ============================================================
    const typeBtns = document.querySelectorAll('.type-btn');
    const goalBtns = document.querySelectorAll('.goal-btn');

    typeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          typeBtns.forEach(b => {
              b.classList.remove('border-airtur-blue', 'bg-blue-50');
              b.classList.add('border-gray-200');
              b.querySelector('svg')?.classList.remove('text-airtur-blue');
              b.querySelector('svg')?.classList.add('text-gray-400');
          });
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-airtur-blue', 'bg-blue-50');
          btn.querySelector('svg')?.classList.remove('text-gray-400');
          btn.querySelector('svg')?.classList.add('text-airtur-blue');
          
          state.buildingType = btn.dataset.value;
          state.buildingFactor = parseFloat(btn.dataset.factor);
          
          const goalSection = document.querySelector('.goal-btn')?.closest('div')?.parentElement;
          scrollToElement(goalSection);

          checkStep1Completion();
      });
    });

    goalBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          if(!state.buildingType) {
              alert("Prosz najpierw wybra typ budynku.");
              return;
          }
          goalBtns.forEach(b => {
              b.classList.remove('border-airtur-blue', 'bg-blue-50');
              b.classList.add('border-gray-200');
          });
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-airtur-blue', 'bg-blue-50');
          state.goal = btn.dataset.goal;
          checkStep1Completion();
      });
    });

    function checkStep1Completion() {
      if(state.buildingType && state.goal) {
          steps[0].classList.add('hidden');
          if(stepLoading) {
              stepLoading.classList.remove('hidden');
              stepLoading.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          
          setTimeout(() => {
              if(stepLoading) stepLoading.classList.add('hidden');
              setupStep2Defaults();
              goToStep(1); 
          }, 1000); 
      }
    }

    // ============================================================
    // 4. LOGIKA KROKU 2 (DOBR MOCY) - NOWA OBSUGA KART
    // ============================================================
    function setupStep2Defaults() {
      const sunRadios = document.querySelectorAll('input[name="sun"]');
      sunRadios.forEach(r => { if(r.value === "0.10") r.checked = true; });
      if(state.buildingType === 'poddasze') {
          sunRadios.forEach(r => { if(r.value === "0.13") r.click(); });
      } else {
          updateSunDescription(0.10);
      }
    }
    
    function updateSunDescription(factor) {
        const desc = document.getElementById('sun-desc');
        if(desc) {
            if(factor === 0.08) desc.innerText = "Okna od p贸nocy/wschodu, parter, dobra izolacja.";
            if(factor === 0.10) desc.innerText = "Okna od zachodu, standardowe mieszkanie.";
            if(factor === 0.13) desc.innerText = "Okna od poudnia, du偶e przeszklenia, poddasze.";
        }
    }

    const areaSlider = document.getElementById('area-slider');
    const areaInput = document.getElementById('area-input');
    
    areaSlider?.addEventListener('input', (e) => {
      if(areaInput) areaInput.value = e.target.value;
      state.area = parseInt(e.target.value);
    });
    areaInput?.addEventListener('input', (e) => {
      let val = parseInt(e.target.value);
      if(val > 500) val = 500; 
      if(val < 10) val = 10;
      if(areaSlider) areaSlider.value = val;
      state.area = val;
    });

    document.getElementById('calculate-btn')?.addEventListener('click', () => {
      let basePower = (state.area * state.sunFactor) + state.peopleLoad;
      let finalPower = basePower * state.buildingFactor;
      state.calculatedPower = finalPower.toFixed(1);

      const tempRes = document.getElementById('temp-result-power');
      if(tempRes) tempRes.innerText = state.calculatedPower;
      
      calculateAndShow3Models();

      const interResult = document.getElementById('intermediate-result');
      if(interResult) {
          interResult.classList.remove('hidden');
          interResult.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      syncWithConversionForm();
    });

    document.getElementById('go-to-roi-btn')?.addEventListener('click', () => {
        goToStep(2);
    });

    // ============================================================
    // OBSUGA KLIKNI W KARTY MODELI (Step 2)
    // ============================================================
    function activateCard(cardType) {
        const cards = ['eco', 'smart', 'premium'];
        cards.forEach(type => {
            const cardEl = document.getElementById(`card-${type}`);
            if(cardEl) {
                if(type === cardType) {
                    cardEl.classList.add('ring-4', 'ring-airtur-blue/50');
                } else {
                    cardEl.classList.remove('ring-4', 'ring-airtur-blue/50');
                }
            }
        });

        //  To jest krytyczne: zapisujemy, 偶e wybra 'eco', 'smart' lub 'premium'
        state.activeModelKey = cardType;
        const selectedModel = state.selectedModels[cardType];
        
        if (selectedModel) {
            state.recommendedModel = selectedModel.name;
            state.recommendedDesc = selectedModel.desc;
            
            const finalModelName = document.getElementById('final-model-name');
            if(finalModelName) finalModelName.innerText = selectedModel.name;
        }
        syncWithConversionForm();
    }

    ['eco', 'smart', 'premium'].forEach(type => {
        const card = document.getElementById(`card-${type}`);
        if(card) {
            card.addEventListener('click', () => activateCard(type));
            card.style.cursor = 'pointer'; 
        }
    });


    // ============================================================
    // 5. LOGIKA KROKU 3 (FINANSE)
    // ============================================================
    const billSlider = document.getElementById('bill-slider');
    const billInput = document.getElementById('bill-input');

    billSlider?.addEventListener('input', (e) => {
      if(billInput) billInput.value = e.target.value;
      state.billAmount = parseInt(e.target.value);
    });
    billInput?.addEventListener('input', (e) => {
      let val = parseInt(e.target.value);
      if(val > 10000) val = 10000;
      if(val < 100) val = 100;
      if(billSlider) billSlider.value = val;
      state.billAmount = val;
    });

    document.getElementById('roi-btn')?.addEventListener('click', () => {
      if(!state.selectedFuel) {
          alert("Prosz wybra obecne 藕r贸do ogrzewania.");
          return;
      }
      calculateAdvancedFinancials(); 
      syncWithConversionForm();
      
      populateStep4Table();

      goToStep(3);
      
      setTimeout(() => {
          const step4 = document.getElementById('step-4');
          if (step4) {
              step4.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
      }, 1200);
    });

    // ============================================================
    // 6. NOWE FUNKCJE BIZNESOWE (3 MODELE)
    // ============================================================
    
    function calculateAndShow3Models() {
      const power = parseFloat(state.calculatedPower);
      let basket = '2.5';
      
      if(power <= 2.8) basket = '2.5';
      else if(power <= 3.8) basket = '3.5';
      else if(power <= 5.5) basket = '5.0';
      else if(power <= 7.2) basket = '7.0';
      else basket = '7.0'; 

      let availableModels = [];
      
      if (typeof models !== 'undefined' && models[state.goal] && models[state.goal][basket]) {
         availableModels = models[state.goal][basket];
      } else {
         availableModels = [
             { name: 'Model Podstawowy', desc: 'Opis...', cat: 'Standard' },
             { name: 'Model Ekspert', desc: 'Opis...', cat: 'Zoty rodek' },
             { name: 'Model Premium', desc: 'Opis...', cat: 'Premium' }
         ];
      }

      const selection = selectThreeModels(availableModels);
      state.selectedModels = selection;

      if(selection.eco) {
          const elName = document.getElementById('model-eco-name');
          const elDesc = document.getElementById('model-eco-desc');
          if(elName) elName.innerText = selection.eco.name;
          if(elDesc) elDesc.innerText = selection.eco.desc;
      }
      if(selection.smart) {
          const elName = document.getElementById('model-smart-name');
          const elDesc = document.getElementById('model-smart-desc');
          if(elName) elName.innerText = selection.smart.name;
          if(elDesc) elDesc.innerText = selection.smart.desc;
      }
      if(selection.premium) {
          const elName = document.getElementById('model-premium-name');
          const elDesc = document.getElementById('model-premium-desc');
          if(elName) elName.innerText = selection.premium.name;
          if(elDesc) elDesc.innerText = selection.premium.desc;
      }

      activateCard('smart');
    }

    function populateStep4Table() {
        const { eco, smart, premium } = state.selectedModels;
        
        const fillText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.innerText = text || '-';
        };

        fillText('summary-area', `${state.area} m虏`);
        let sunTxt = "Standardowe";
        if(state.sunFactor === 0.08) sunTxt = "Niskie";
        if(state.sunFactor === 0.13) sunTxt = "Wysokie";
        fillText('summary-sun', sunTxt);
        fillText('summary-power', `${state.calculatedPower} kW`); 

        const content = transitionContent[state.goal];
        if (content) {
            fillText('transition-headline', content.headline);
            fillText('transition-subtext', content.subtext);
        }

        if(eco) {
            fillText('table-eco-name', eco.name);
            fillText('table-eco-energy', eco.energy_class);
            fillText('table-eco-noise', eco.noise);
            fillText('table-eco-filter', eco.filter);
        }
        if(smart) {
            fillText('table-smart-name', smart.name);
            fillText('table-smart-energy', smart.energy_class);
            fillText('table-smart-noise', smart.noise);
            fillText('table-smart-filter', smart.filter);
        }
        if(premium) {
            fillText('table-premium-name', premium.name);
            fillText('table-premium-energy', premium.energy_class);
            fillText('table-premium-noise', premium.noise);
            fillText('table-premium-filter', premium.filter);
        }
    }

    function calculateAdvancedFinancials() {
        const bill = state.billAmount; 
        const fuel = MARKET_DATA.fuels[state.selectedFuel]; 
        
        if (!fuel) return;

        const fuelUnits = bill / fuel.price; 
        const theoreticalEnergy = fuelUnits * fuel.value;
        let effectiveHeat = theoreticalEnergy * fuel.efficiency;

        if (state.comfortLevel === 'low') {
            effectiveHeat = effectiveHeat * 1.25; 
        } else if (state.comfortLevel === 'standard') {
            effectiveHeat = effectiveHeat * 1.05; 
        }

        const electricityNeeded = effectiveHeat / MARKET_DATA.airturSCOP;
        const costAirTUR = Math.round(electricityNeeded * MARKET_DATA.electricityPrice);
        const costOld = bill;

        const savingsMonth = costOld - costAirTUR;
        
        state.savingsYear = savingsMonth * 5; 
        state.savings5Years = state.savingsYear * 5;
        state.savings10Years = state.savingsYear * 10;

        const costOldEl = document.getElementById('cost-old');
        const costNewEl = document.getElementById('cost-new');
        
        if(costOldEl) costOldEl.innerText = `${costOld} z`;
        if(costNewEl) costNewEl.innerText = `~${costAirTUR} z`;
        
        const barWidth = Math.min((costAirTUR / costOld) * 100, 100);
        setTimeout(() => {
            const barNew = document.getElementById('bar-new');
            if(barNew) barNew.style.width = `${barWidth}%`;
        }, 500);

        animateValue('savings-year', 0, Math.max(0, state.savingsYear), 2000);
        animateValue('savings-5years', 0, Math.max(0, state.savings5Years), 2000);
        animateValue('savings-10years', 0, Math.max(0, state.savings10Years), 2000);
    }

    function animateValue(id, start, end, duration) {
      const obj = document.getElementById(id);
      if(!obj) return;
      let startTimestamp = null;
      const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('pl-PL');
          if (progress < 1) {
              window.requestAnimationFrame(step);
          }
      };
      window.requestAnimationFrame(step);
    }

    // ============================================================
    // 7. OBSUGA WYBORU W STEP 4 - STEROWANIE KONWERSJ
    // ============================================================
    const conversionSection = document.getElementById('conversion-section');
    const mainPhoneContainer = document.getElementById('main-phone-container');
    const secondaryPhoneSection = document.getElementById('secondary-phone-section');
    
    // A. "Chc wycen z monta偶em" (Gorcy Lead)
    document.getElementById('cta-request-quote')?.addEventListener('click', () => {
        conversionSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        document.querySelectorAll('input[name="cel"]').forEach(input => {
            input.value = 'chce_montaz'; 
        });

        if(mainPhoneContainer) {
            mainPhoneContainer.classList.remove('hidden');
            const phoneInput = mainPhoneContainer.querySelector('input');
            if(phoneInput) phoneInput.required = true;
        }
        if(secondaryPhoneSection) {
            secondaryPhoneSection.classList.add('hidden');
        }

        const header = conversionSection?.querySelector('h2');
        const sub = conversionSection?.querySelector('p');
        if(header) {
            header.innerText = "wietna decyzja! Um贸wmy bezpatn wycen.";
            header.classList.remove('text-white');
            header.classList.add('text-airtur-blue');
        }
        if(sub) {
            sub.innerText = `Nasz in偶ynier przeanalizuje wynik dla modelu ${state.recommendedModel}. Zostaw numer telefonu, abymy mogli przygotowa ofert.`;
        }
    });

    // B. "Chc tylko raport" (Zimny Lead)
    document.getElementById('cta-get-report')?.addEventListener('click', () => {
        conversionSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        document.querySelectorAll('input[name="cel"]').forEach(input => {
            input.value = 'raport_wyslany'; 
        });

        if(mainPhoneContainer) {
            mainPhoneContainer.classList.add('hidden');
            const phoneInput = mainPhoneContainer.querySelector('input');
            if(phoneInput) phoneInput.required = false;
        }
        if(secondaryPhoneSection) {
            secondaryPhoneSection.classList.remove('hidden');
        }

        const header = conversionSection?.querySelector('h2');
        const sub = conversionSection?.querySelector('p');
        if(header) {
            header.innerText = "Twoja osobista Analiza Inwestycyjna jest gotowa.";
            header.classList.remove('text-airtur-blue');
            header.classList.add('text-white');
        }
        if(sub) {
            sub.innerText = "Wyniki Twoich oblicze to doskonay fundament. Odbierz peny raport PDF na sw贸j e-mail.";
        }
    });

  });
</script>