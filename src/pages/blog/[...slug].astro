---
export const prerender = true;
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/blog/TableOfContents.astro';
// 1. IMPORTUJEMY BAZĘ AUTORÓW
import { BLOG_AUTHORS } from '../../content/config';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

const { entry } = Astro.props;

// 1. Zmieniamy nazwę pobranych nagłówków na 'rawHeadings', żeby je zaraz obrobić
const { Content, headings: rawHeadings } = await entry.render();

// 2. FILTROWANIE: Usuwamy z listy wszelkie nagłówki, które w tekście mają "faq" (wielkość liter nie ma znaczenia).
//    Dzięki temu, nawet jak w pliku .md wpisałaś "## FAQ", to tutaj to zniknie i nie będzie dubla.
const headings = rawHeadings.filter(h => !h.text.toLowerCase().includes('faq'));

// 3. DODAWANIE: Teraz dodajemy nasze systemowe FAQ (jeśli istnieje w configu)
if (entry.data.faq && entry.data.faq.length > 0) {
  headings.push({
    depth: 2,              
    slug: 'faq-sekcja',   // To ID jest kluczowe dla poprawnego podświetlania
    text: 'FAQ – Pytania i odpowiedzi' 
  });
}

const seoTitle = entry.data.meta?.title || `${entry.data.title} - Blog AirTUR`;
const seoDescription = entry.data.meta?.description || entry.data.excerpt;
const showTOC = entry.data.showTOC;

// --- LOGIKA WYBORU AUTORA (ZMODYFIKOWANA) ---
// 1. Pobieramy to, co wpisałaś w .md, usuwamy spacje
const rawAuthorInput = entry.data.author ? entry.data.author.trim() : '';
// 2. Zamieniamy na małe litery, żeby pasowało do kluczy w configu (np. "Klaudia" -> "klaudia")
const authorKey = rawAuthorInput.toLowerCase();

// 3. Pobieramy dane z configu.
//    - Jeśli klucz istnieje (np. 'klaudia'), bierzemy jej dane.
//    - Jeśli klucz NIE istnieje (np. 'marta') lub jest pusty, bierzemy 'default' (Zespół AirTUR).
const authorData = BLOG_AUTHORS[authorKey] || BLOG_AUTHORS['default'];
---

<Layout title={seoTitle} description={seoDescription}>
  
  <header class="bg-gray-50 pt-32 pb-16 border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <span class="inline-block bg-airtur-blue/10 text-airtur-blue text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider mb-6">
        {entry.data.category}
      </span>
      <h1 class="text-3xl md:text-5xl font-extrabold text-airtur-dark mb-6 leading-tight">
        {entry.data.title}
      </h1>
      {entry.data.updatedDate && (
        <div class="inline-block mb-8 px-5 py-2 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm font-medium shadow-sm animate-fade-in">
            ✨ Aktualizacja: {entry.data.updatedDate.toLocaleDateString('pl-PL')} – Ten artykuł został odświeżony.
        </div>
      )}
      <div class="flex flex-wrap justify-center items-center gap-4 text-sm text-gray-500 font-medium">
        <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-airtur-blue"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 0 0-13.074.003Z" /></svg>
            {/* Tutaj wyświetlamy pełne imię z configu */}
            {authorData.name}
        </span>
        <span class="text-gray-300">|</span>
        <span>{entry.data.readingTime} czytania</span>
        <span class="text-gray-300">|</span>
        <time datetime={entry.data.pubDate.toISOString()}>
          {entry.data.pubDate.toLocaleDateString('pl-PL')}
        </time>
      </div>
    </div>
  </header>

  <article class="py-16 bg-white relative">
    
    {showTOC && (
      <button 
        id="toc-reopen-btn"
        class="hidden fixed right-0 top-32 z-40 bg-white border-l border-t border-b border-gray-200 text-airtur-dark p-3 rounded-l-xl shadow-lg hover:text-airtur-blue hover:pl-4 transition-all duration-300 group"
        aria-label="Pokaż spis treści"
        title="Pokaż spis treści"
      >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 17.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
          </svg>
      </button>
    )}

    <div id="main-grid" class={`mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl ${showTOC ? 'grid grid-cols-1 lg:grid-cols-12 gap-12' : ''}`}>
      
      {showTOC && (
        <aside id="sidebar-toc" class="w-full lg:col-span-4 order-first lg:order-last mb-8 lg:mb-0 transition-opacity duration-300">
            <div class="lg:sticky lg:top-32">
                <TableOfContents headings={headings} />
            </div>
        </aside>
      )}

      <div id="content-col" class={`${showTOC ? 'lg:col-span-8' : 'w-full max-w-3xl mx-auto'} transition-all duration-500`}>

        <div class="rounded-2xl overflow-hidden shadow-xl mb-12 border border-gray-100">
            <img src={entry.data.image} alt={entry.data.title} class="w-full h-auto object-cover" onerror="this.onerror=null; this.src='https://placehold.co/800x400?text=Brak+Zdjecia';" />
        </div>

        {entry.data.keyTakeaways && (
            <div class="bg-[#F8F9FA] border-l-4 border-airtur-blue p-6 md:p-8 rounded-r-xl mb-12 shadow-sm">
                <h3 class="text-xl font-bold text-airtur-dark mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-airtur-blue"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.45l.75 2.625c.203.71-.402 1.425-1.14 1.346a49.99 49.99 0 0 0-2.22 0c-.738.08-1.343-.636-1.14-1.346l.75-2.625c.42.152.855.297 1.5.45Zm0-5.25V6m0-2.25h.008v.008H12V3.75Z" /></svg>
                    W tym raporcie:
                </h3>
                <ul class="space-y-3">
                    {entry.data.keyTakeaways.map(p => <li class="flex items-start gap-3 text-gray-700 text-sm md:text-base font-medium"><span class="text-airtur-blue mt-1.5">•</span><span>{p}</span></li>)}
                </ul>
            </div>
        )}

        <div id="inner-content" class="blog-content text-gray-700 leading-relaxed text-lg">
            <Content />
        </div>

        {entry.data.faq && entry.data.faq.length > 0 && (
            <div class="mt-16 pt-10 border-t border-gray-100">
                <h3 id="faq-sekcja" class="text-2xl font-bold text-airtur-dark mb-6 scroll-mt-32">FAQ – Najczęściej zadawane pytania</h3>
                <div class="space-y-4">
                    {entry.data.faq.map((item, index) => (
                        <div id={`faq-${index}`} class="faq-item border border-gray-200 rounded-lg overflow-hidden bg-white transition-all hover:border-airtur-blue/30 scroll-mt-32">
                            <button class="faq-toggle w-full flex justify-between items-center p-4 text-left focus:outline-none group">
                                <span class="text-base font-bold text-airtur-dark group-hover:text-airtur-blue transition-colors pr-4">{item.question}</span>
                                <div class="relative w-5 h-5 flex items-center justify-center text-airtur-blue flex-shrink-0"><span class="absolute w-full h-0.5 bg-current transform transition-transform duration-300 icon-horizontal"></span><span class="absolute h-full w-0.5 bg-current transform transition-transform duration-300 icon-vertical"></span></div>
                            </button>
                            <div class="faq-answer max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                              <div class="p-4 pt-0 text-sm text-gray-600 leading-relaxed border-t border-transparent">{item.answer}</div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* --- SEKCJA AUTORA (POPRAWIONA) --- */}
        <div class="mt-16 pt-10 border-t border-gray-100 flex flex-col sm:flex-row items-center sm:items-start gap-6 text-center sm:text-left">
            {/* Wyświetlaj div ze zdjęciem TYLKO jeśli avatar nie jest pusty w configu */}
            {authorData.avatar && (
              <div class="w-20 h-20 bg-gray-100 rounded-full overflow-hidden flex-shrink-0 border-2 border-white shadow-md">
                  <img src={authorData.avatar} alt={authorData.name} class="w-full h-full object-cover" onerror="this.style.display='none';" />
              </div>
            )}
            
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest font-bold mb-1">Autor analizy</p>
                <p class="text-xl font-bold text-airtur-dark mb-2">{authorData.name}</p>
                <p class="text-sm text-gray-500">{authorData.role}. {authorData.description}</p>
            </div>
        </div>
        {/* --- KONIEC SEKCJI AUTORA --- */}

        <div class="mt-12 text-center">
            <a href="/baza-wiedzy" class="inline-flex items-center gap-2 text-airtur-blue font-bold hover:text-airtur-navy transition-colors px-6 py-3 rounded-lg hover:bg-blue-50"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" /></svg> Wróć do Bazy Wiedzy</a>
        </div>

      </div>
    </div>
  </article>

  <button id="scroll-to-top" class="fixed bottom-24 md:bottom-6 right-6 z-50 flex items-center gap-2 px-5 py-3 rounded-full bg-airtur-blue text-white font-bold shadow-xl hover:bg-airtur-navy transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" /></svg> Na górę
  </button>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- OBSŁUGA UKRYWANIA SPISU TREŚCI ---
    const sidebar = document.getElementById('sidebar-toc');
    const contentCol = document.getElementById('content-col');
    const closeBtnDesktop = document.getElementById('toc-close-btn-desktop'); 
    const openBtn = document.getElementById('toc-reopen-btn');
    const DESKTOP = 1024;

    const hideSidebar = () => {
      if (!sidebar || window.innerWidth < DESKTOP) return;
      sidebar.classList.add('opacity-0','pointer-events-none','-translate-x-4');
      contentCol.classList.remove('lg:col-span-8');
      contentCol.classList.add('lg:col-span-12', 'max-w-[820px]', 'mx-auto');
      openBtn?.classList.remove('hidden');
      setTimeout(()=> sidebar.classList.add('hidden'), 300);
    };

    const showSidebar = () => {
      if (!sidebar || window.innerWidth < DESKTOP) return;
      sidebar.classList.remove('hidden');
      contentCol.classList.remove('lg:col-span-12', 'max-w-[820px]', 'mx-auto');
      contentCol.classList.add('lg:col-span-8');
      requestAnimationFrame(() => {
        sidebar.classList.remove('opacity-0','pointer-events-none','-translate-x-4');
      });
      openBtn?.classList.add('hidden');
    };

    closeBtnDesktop?.addEventListener('click', hideSidebar);
    openBtn?.addEventListener('click', showSidebar);

    // --- LOGIKA FAQ ---
    const openFaqItem = (item) => {
      if (!item) return;
      const answer = item.querySelector('.faq-answer');
      const iconVert = item.querySelector('.icon-vertical');
      
      document.querySelectorAll('.faq-answer').forEach(ans => {
        if (ans !== answer) {
          ans.style.maxHeight = '0px';
          ans.classList.add('max-h-0');
          ans.closest('.faq-item').classList.remove('bg-blue-50', 'border-airtur-blue');
          const otherIcon = ans.closest('.faq-item').querySelector('.icon-vertical');
          if (otherIcon) otherIcon.classList.remove('rotate-90', 'opacity-0');
        }
      });

      answer.classList.remove('max-h-0');
      answer.style.maxHeight = answer.scrollHeight + 'px';
      item.classList.add('bg-blue-50', 'border-airtur-blue');
      if(iconVert) iconVert.classList.add('rotate-90', 'opacity-0');
    };

    const faqToggles = document.querySelectorAll('.faq-toggle');
    faqToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const item = toggle.closest('.faq-item');
        const answer = item.querySelector('.faq-answer');
        if (!answer.classList.contains('max-h-0')) {
          answer.style.maxHeight = '0px';
          answer.classList.add('max-h-0');
          item.classList.remove('bg-blue-50', 'border-airtur-blue');
          const iconVert = item.querySelector('.icon-vertical');
          if(iconVert) iconVert.classList.remove('rotate-90', 'opacity-0');
        } else {
          openFaqItem(item);
        }
      });
    });

    // --- POPRAWIONA OBSŁUGA GŁĘBOKICH LINKÓW ---
    const handleAnchor = () => {
      const hash = window.location.hash;
      if(hash && hash.startsWith('#faq-')) {
          const targetId = hash.substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
              setTimeout(() => {
                  targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  openFaqItem(targetElement);
                  targetElement.classList.add('faq-highlight');
                  setTimeout(() => targetElement.classList.remove('faq-highlight'), 3000);
              }, 500); 
          }
      }
    };

    window.addEventListener('load', handleAnchor);
    window.addEventListener('hashchange', handleAnchor);

    // --- Scroll To Top ---
    const scrollBtn = document.getElementById('scroll-to-top');
    if (scrollBtn) {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 500) scrollBtn.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            else scrollBtn.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
        });
        scrollBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if(window.location.hash) history.replaceState(null, '', window.location.pathname);
        });
    }

    // --- TOC Auto Scroll ---
    const tocWrapper = document.querySelector('#sidebar-toc > div');
    
    function scrollTOCToActive() {
      // ZABEZPIECZENIE (Mobile)
      if (window.innerWidth < 1024) return;

      const activeLink = document.querySelector('#sidebar-toc a.active');
      if (!activeLink || !tocWrapper) return;
      activeLink.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') scrollTOCToActive();
      });
    });
    
    document.querySelectorAll('#sidebar-toc a').forEach(link => {
      observer.observe(link, { attributes: true });
    });
  });
</script>

<style is:global>
  #content-col {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0AB3C6; }

  .faq-highlight { 
    animation: faqPulse 2.5s ease-out forwards; 
    border-radius: 8px;
  }
  @keyframes faqPulse { 
    0% { background-color: rgba(10, 179, 198, 0.3); } 
    100% { background-color: transparent; } 
  }

  .blog-content h2 { font-size: 1.8rem; font-weight: 800; color: #3A4149; margin-top: 3rem; margin-bottom: 1.5rem; line-height: 1.3; }
  .blog-content h3 { font-size: 1.4rem; font-weight: 700; color: #3A4149; margin-top: 2.5rem; margin-bottom: 1rem; }
  .blog-content p { margin-bottom: 1.5rem; }
  .blog-content strong { font-weight: 700; color: #212529; }
  .blog-content ul { list-style-type: none; margin-bottom: 2rem; padding-left: 0; }
  .blog-content ul li { position: relative; padding-left: 1.5rem; margin-bottom: 0.75rem; }
  .blog-content ul li::before { content: "•"; color: #0AB3C6; font-weight: bold; position: absolute; left: 0; font-size: 1.2em; line-height: 1.5rem; }
  .blog-content blockquote { border-left: 4px solid #0AB3C6; background-color: #F8F9FA; padding: 2rem; border-radius: 0 16px 16px 0; margin: 3rem 0; font-style: italic; color: #4B5563; }
  .blog-content blockquote p { margin: 0; }
  .blog-content blockquote a { display: inline-block; margin-top: 1rem; background-color: #0AB3C6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 700; text-decoration: none; font-style: normal; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.05em; transition: background-color 0.2s; }
  .blog-content blockquote a:hover { background-color: #08909f; }
  .blog-content table { width: 100%; margin: 2.5rem 0; border-collapse: collapse; font-size: 0.95em; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden; }
  .blog-content th { background-color: #3A4149; color: white; padding: 16px; text-align: center; font-weight: 600; }
  .blog-content td { padding: 14px 16px; border-bottom: 1px solid #E5E7EB; color: #4B5563; }
  .blog-content tr:last-child td { border-bottom: none; }
  .blog-content tr:nth-child(even) { background-color: #F9FAFB; }
  .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; margin: 2.5rem 0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 2.5rem 0; }
  .gallery-grid img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; margin: 0 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
  .gallery-grid img:hover { transform: scale(1.02); }
  figure { margin: 2.5rem 0; text-align: center; }
  figure img { border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  figcaption { margin-top: 0.75rem; font-size: 0.875rem; color: #6B7280; font-style: italic; }
</style>